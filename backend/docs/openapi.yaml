openapi: 3.0.0
info:
  title: Interview AI Platform API
  version: 1.0.0
  description: API documentation for the Interview AI MVP backend.

servers:
  - url: http://localhost:5001/api

paths:

  # ---------------------
  # AUTH
  # ---------------------

  /auth/register:
    post:
      summary: Register new user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterRequest"
      responses:
        "201":
          description: User successfully registered
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RegisterResponse"

  /auth/login:
    post:
      summary: Login and get JWT token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
      responses:
        "200":
          description: Login success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"

  /auth/forgot-password:
    post:
      summary: Request password reset
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ForgotPasswordRequest"
      responses:
        "200":
          description: Reset email triggered
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BaseResponse"

  /auth/reset-password:
    post:
      summary: Reset password with token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ResetPasswordRequest"
      responses:
        "200":
          description: Password successfully reset
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BaseResponse"

  /auth/google:
    post:
      summary: Initiate Google OAuth login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                redirect_uri:
                  type: string
                  description: Frontend callback URL
      responses:
        "200":
          description: OAuth URL returned
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GoogleOAuthInitResponse"

  /auth/google/callback:
    get:
      summary: Handle Google OAuth callback
      parameters:
        - in: query
          name: code
          required: true
          schema:
            type: string
          description: Authorization code from Google
        - in: query
          name: state
          schema:
            type: string
          description: State parameter for CSRF protection
      responses:
        "200":
          description: Authentication successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"

  # ---------------------
  # USER
  # ---------------------

  /user/profile:
    get:
      summary: Get user profile
      security:
        - bearerAuth: []
      responses:
        "200":
          description: User profile returned
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserProfileResponse"

    patch:
      summary: Update user profile
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserProfileUpdateRequest"
      responses:
        "200":
          description: Updated profile
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserProfileResponse"

  # ---------------------
  # CV OPTIMIZATION
  # ---------------------

  /cv/optimize:
    post:
      summary: Optimize a CV based on job description
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CVOptimizeRequest"
      responses:
        "200":
          description: Optimized CV returned
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CVOptimizeResponse"

  /cv/upload:
    post:
      summary: Upload a CV file (PDF)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                  description: CV file (PDF, max 10MB)
      responses:
        "201":
          description: CV uploaded successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CVUploadResponse"

  /cv/:
    get:
      summary: List all CVs for authenticated user
      security:
        - bearerAuth: []
      responses:
        "200":
          description: List of user's CVs
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CVListResponse"

  /cv/{cvId}:
    get:
      summary: Get specific CV by ID
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: cvId
          required: true
          schema:
            type: string
          description: CV unique identifier
      responses:
        "200":
          description: CV details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CVDetailResponse"

  # ---------------------
  # INTERVIEW
  # ---------------------

  /interview/:
    post:
      summary: Create a new interview
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/InterviewCreateRequest"
      responses:
        "201":
          description: Interview created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InterviewCreateResponse"
    
    get:
      summary: List all interviews for authenticated user
      security:
        - bearerAuth: []
      responses:
        "200":
          description: List of interviews
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InterviewListResponse"

  /interview/{interviewId}:
    get:
      summary: Get interview details
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: interviewId
          required: true
          schema:
            type: string
          description: Interview unique identifier
      responses:
        "200":
          description: Interview details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InterviewDetailResponse"

  /interview/{interviewId}/sessions:
    post:
      summary: Start a new interview session
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: interviewId
          required: true
          schema:
            type: string
          description: Interview unique identifier
      responses:
        "201":
          description: Session started
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SessionStartResponse"

  /interview/sessions/{sessionId}/answer:
    post:
      summary: Submit answer to interview question
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: string
          description: Session unique identifier
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AnswerRequest"
      responses:
        "200":
          description: Answer submitted, next question returned
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AnswerResponse"

  /interview/sessions/{sessionId}/evaluate:
    post:
      summary: Evaluate interview session
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: string
          description: Session unique identifier
      responses:
        "200":
          description: Evaluation completed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EvaluationResponse"

  /interview/sessions/{sessionId}:
    get:
      summary: Get session details
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: string
          description: Session unique identifier
      responses:
        "200":
          description: Session details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SessionDetailResponse"

  # ---------------------
  # SYSTEM / DEBUG
  # ---------------------

  /system/health:
    get:
      summary: Health check
      responses:
        "200":
          description: Health information
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SystemHealthResponse"

  /system/rag-debug-query:
    post:
      summary: Test RAG retrieval
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RAGDebugRequest"
      responses:
        "200":
          description: RAG results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RAGDebugResponse"

# -------------------------------------------------------
# COMPONENT SCHEMAS
# -------------------------------------------------------
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer

  schemas:

    # Base Response
    BaseResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          nullable: true
        error:
          nullable: true

    # AUTH SCHEMAS
    RegisterRequest:
      type: object
      required: [email, password, full_name]
      properties:
        email:
          type: string
        password:
          type: string
        full_name:
          type: string

    RegisterResponse:
      allOf:
        - $ref: "#/components/schemas/BaseResponse"
        - type: object
          properties:
            data:
              type: object
              properties:
                user_id:
                  type: string
                email:
                  type: string
                full_name:
                  type: string

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
        password:
          type: string

    LoginResponse:
      allOf:
        - $ref: "#/components/schemas/BaseResponse"
        - type: object
          properties:
            data:
              type: object
              properties:
                access_token:
                  type: string
                expires_in:
                  type: integer

    ForgotPasswordRequest:
      type: object
      required: [email]
      properties:
        email:
          type: string

    ResetPasswordRequest:
      type: object
      required: [reset_token, new_password]
      properties:
        reset_token:
          type: string
        new_password:
          type: string

    # USER SCHEMAS
    UserProfileResponse:
      allOf:
        - $ref: "#/components/schemas/BaseResponse"
        - type: object
          properties:
            data:
              type: object
              properties:
                user_id: { type: string }
                email: { type: string }
                full_name: { type: string }
                avatar_url: { type: string }
                bio: { type: string }
                linkedin: { type: string }
                github: { type: string }

    UserProfileUpdateRequest:
      type: object
      properties:
        full_name: { type: string }
        avatar_url: { type: string }
        bio: { type: string }
        linkedin: { type: string }
        github: { type: string }

    # CV OPTIMIZATION
    CVOptimizeRequest:
      type: object
      required: [cv_text, job_description]
      properties:
        cv_text: { type: string }
        job_description: { type: string }

    CVOptimizeResponse:
      allOf:
        - $ref: "#/components/schemas/BaseResponse"
        - type: object
          properties:
            data:
              type: object
              properties:
                optimized_cv: { type: string }
                missing_keywords:
                  type: array
                  items: { type: string }
                suggestions:
                  type: array
                  items: { type: string }

    CVUploadResponse:
      allOf:
        - $ref: "#/components/schemas/BaseResponse"
        - type: object
          properties:
            data:
              type: object
              properties:
                cv_id: { type: string }
                filename: { type: string }
                s3_url: { type: string }
                uploaded_at: { type: string }

    CVListResponse:
      allOf:
        - $ref: "#/components/schemas/BaseResponse"
        - type: object
          properties:
            data:
              type: array
              items:
                type: object
                properties:
                  id: { type: string }
                  filename: { type: string }
                  uploaded_at: { type: string }

    CVDetailResponse:
      allOf:
        - $ref: "#/components/schemas/BaseResponse"
        - type: object
          properties:
            data:
              type: object
              properties:
                id: { type: string }
                filename: { type: string }
                s3_url: { type: string }
                uploaded_at: { type: string }
                user_id: { type: string }

    # GOOGLE OAUTH SCHEMAS
    GoogleOAuthInitResponse:
      allOf:
        - $ref: "#/components/schemas/BaseResponse"
        - type: object
          properties:
            data:
              type: object
              properties:
                auth_url:
                  type: string
                  description: Google OAuth authorization URL


    # INTERVIEW SCHEMAS
    InterviewCreateRequest:
      type: object
      properties:
        title: { type: string }
        position: { type: string }
        cv_id: { type: string }

    InterviewCreateResponse:
      allOf:
        - $ref: "#/components/schemas/BaseResponse"
        - type: object
          properties:
            data:
              type: object
              properties:
                interview_id: { type: string }
                title: { type: string }
                position: { type: string }

    InterviewListResponse:
      allOf:
        - $ref: "#/components/schemas/BaseResponse"
        - type: object
          properties:
            data:
              type: array
              items:
                type: object
                properties:
                  id: { type: string }
                  title: { type: string }
                  position: { type: string }
                  created_at: { type: string }

    InterviewDetailResponse:
      allOf:
        - $ref: "#/components/schemas/BaseResponse"
        - type: object
          properties:
            data:
              type: object
              properties:
                id: { type: string }
                title: { type: string }
                position: { type: string }
                cv_id: { type: string }
                created_at: { type: string }

    SessionStartResponse:
      allOf:
        - $ref: "#/components/schemas/BaseResponse"
        - type: object
          properties:
            data:
              type: object
              properties:
                session_id: { type: string }
                first_question: { type: string }

    AnswerRequest:
      type: object
      required: [answer]
      properties:
        answer: { type: string }

    AnswerResponse:
      allOf:
        - $ref: "#/components/schemas/BaseResponse"
        - type: object
          properties:
            data:
              type: object
              properties:
                next_question: { type: string }
                is_followup: { type: boolean }
                is_last: { type: boolean }

    EvaluationResponse:
      allOf:
        - $ref: "#/components/schemas/BaseResponse"
        - type: object
          properties:
            data:
              type: object
              properties:
                score: { type: number }
                strengths:
                  type: array
                  items: { type: string }
                weaknesses:
                  type: array
                  items: { type: string }
                recommendations:
                  type: array
                  items: { type: string }

    SessionDetailResponse:
      allOf:
        - $ref: "#/components/schemas/BaseResponse"
        - type: object
          properties:
            data:
              type: object
              properties:
                session_id: { type: string }
                interview_id: { type: string }
                position: { type: string }
                status: { type: string }
                started_at: { type: string }
                ended_at: { type: string }
                questions_count: { type: integer }

    # SYSTEM
    SystemHealthResponse:
      allOf:
        - $ref: "#/components/schemas/BaseResponse"
        - type: object
          properties:
            data:
              type: object
              properties:
                status: { type: string }
                uptime_sec: { type: number }

    RAGDebugRequest:
      type: object
      required: [query]
      properties:
        query: { type: string }

    RAGDebugResponse:
      allOf:
        - $ref: "#/components/schemas/BaseResponse"
        - type: object
          properties:
            data:
              type: object
              properties:
                retrieved_count: { type: number }
                results:
                  type: array
                  items:
                    type: object
                    properties:
                      text: { type: string }
                      distance: { type: number }
